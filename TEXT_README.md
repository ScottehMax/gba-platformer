# Text Drawing System for GBA

## Overview
This system provides simple text rendering for GBA using the TinyPixie pixel font. Text is rendered using OAM sprites with variable-width character spacing for better readability.

## Features
- Variable-width font rendering
- ASCII printable characters (space through tilde, chars 32-126)
- 8×8 pixel tiles for GBA compatibility
- Automatic character spacing
- Simple API with 3 functions

## Files
- `text.h` / `text.c` - Text drawing API
- `tools/font_to_spritesheet.py` - TTF to PNG spritesheet converter
- `assets/tinypixie.png` - Generated font spritesheet (128×48 pixels, 16×6 grid)
- `assets/tinypixie_widths.h` - Character width metadata
- `generated/tinypixie.h` / `tinypixie.c` - Generated by grit from PNG

## Setup

### 1. Font Conversion (already done)
Convert a TTF font to a pixel-perfect PNG spritesheet:
```bash
uv run --with=Pillow python tools/font_to_spritesheet.py TinyPixie2.ttf assets/tinypixie.png 6
```
This creates:
- `assets/tinypixie.png` - 128×48 spritesheet (magenta #FF00FF transparent)
- `assets/tinypixie_widths.h` - Character width data for variable-width rendering
- `assets/tinypixie_meta.json` - Metadata (for reference)

### 2. Build System Integration
The Makefile automatically processes the PNG with grit:
```makefile
$(GENDIR)/tinypixie.h: assets/tinypixie.png | $(GENDIR)
	$(GRIT) $< -gB4 -gt -gTFF00FF -ftc -o$(GENDIR)/tinypixie
```

### 3. Initialize in Your Code
```c
#include "text.h"

// In your initialization code (after enabling sprites):

// Load font tiles to sprite VRAM (starting at tile 512 to avoid other sprites)
volatile u32* spriteTiles = (volatile u32*)0x06010000;
int fontTileStart = 512;
for (int i = 0; i < tinypixieTilesLen / 4; i++) {
    spriteTiles[fontTileStart * 8 + i] = tinypixieTiles[i];
}

// Load font palette to sprite palette slot 1 (slot 0 is for other sprites)
volatile u16* spritePalette = (volatile u16*)0x05000200;
for (int i = 0; i < 16; i++) {
    spritePalette[16 + i] = tinypixiePal[i];
}

// Enable sprites in display control
REG_DISPCNT = VIDEOMODE_0 | BG0_ENABLE | OBJ_ENABLE | OBJ_1D_MAP;
```

## API Usage

### Draw Text
```c
// Draw text at screen position (10, 20)
// Uses OAM sprite indices 100-119 (one sprite per character)
int sprites_used = draw_text("Hello World!", 10, 20, 100);
```

**Parameters:**
- `str` - Text string to draw
- `x, y` - Screen coordinates (0-239, 0-159)
- `start_oam_index` - First OAM sprite index to use (0-127)

**Returns:** Number of OAM sprites used

### Draw Single Character
```c
// Draw the letter 'A' at (50, 50) using OAM sprite 10
int width = draw_char('A', 50, 50, 10);
// Returns: 4 (pixels wide)
```

**Returns:** Character width in pixels

### Get Text Width
```c
// Calculate pixel width before drawing (for centering, alignment, etc.)
int width = text_width("Score: 9999");
int centered_x = (SCREEN_WIDTH - width) / 2;
draw_text("Score: 9999", centered_x, 10, 100);
```

**Returns:** Total width in pixels (including character spacing)

## Important Notes

### OAM Sprite Management
- GBA has **128 total OAM sprites** (indices 0-127)
- Each character uses **1 sprite**
- Reserve sprite indices for text (e.g., 100-127 for up to 28 characters)
- Don't overlap text sprites with game object sprites!

### Memory Layout
- Font tiles start at VRAM index **512** (configurable in text.c)
- Font uses sprite **palette slot 1** (configurable in text.c)
- Characters are stored as 8×8 tiles in a 16-wide grid

### Character Spacing
- Characters use variable width (3-7 pixels)
- Automatic 1-pixel spacing between characters
- Space character (` `) is 3 pixels wide

### Performance
- Drawing text every frame is fine for small amounts
- For static text, draw once and leave sprites in place
- Hide unused text sprites by setting attr0 Y-coordinate to 160+

## Example: Frame Counter
```c
int frameCount = 0;

while (1) {
    vsync();
    
    // Update game logic...
    
    // Draw text (updates every frame)
    draw_text("TinyPixie Font", 5, 5, 100);
    
    // Timer (update every 60 frames to reduce flicker)
    if (frameCount % 60 == 0) {
        char timeStr[16];
        sprintf(timeStr, "Time: %ds", frameCount / 60);
        draw_text(timeStr, 5, 15, 115);
    }
    
    frameCount++;
}
```

## Customization

### Change Font Tile Start Position
Edit `text.c`:
```c
#define FONT_TILE_START 512  // Change to avoid collision with other sprites
```

### Change Font Palette
Edit `text.c`:
```c
#define FONT_PALETTE 1  // Change to use different palette slot (0-15)
```

### Use a Different Font
1. Run the conversion script with your TTF file
2. Rebuild the project
3. All done! The system auto-updates

## Troubleshooting

### Text appears as garbage
- Make sure font tiles are loaded to VRAM at the correct offset
- Verify palette is loaded correctly
- Check that sprites are enabled in REG_DISPCNT

### Text doesn't appear
- Verify OAM indices don't exceed 127
- Check X/Y coordinates are on screen (0-239, 0-159)
- Ensure sprites aren't hidden by other sprites (OAM priority)

### Characters overlap or have wrong spacing
- Regenerate the spritesheet with 8×8 cells (not 9×8)
- Check tinypixie_widths.h matches the generated PNG

## Technical Details

### Font Spritesheet Layout
```
128 pixels wide × 48 pixels tall
16 chars per row × 6 rows = 96 character slots (95 used)
Each character: 8×8 pixels (1 GBA tile)
Grid: 16 tiles wide × 6 tiles tall = 96 tiles
```

### Supported Characters
```
ASCII 32-126: !"#$%&'()*+,-./0123456789:;<=>?@
              ABCDEFGHIJKLMNOPQRSTUVWXYZ[\]^_`
              abcdefghijklmnopqrstuvwxyz{|}~
```

### Character Width Table
Stored in `font_char_widths[]` array (see `assets/tinypixie_widths.h`)
- Smallest: 2 pixels (`, i, j, l, !, |)
- Largest: 7 pixels (@, &, M, W)
- Average: ~4 pixels
